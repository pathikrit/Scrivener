<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Scrivener</title>

    <script type="text/javascript" src="http://code.jquery.com/jquery-latest.min.js"></script>
    <script type="text/javascript" src="http://mbostock.github.com/d3/d3.js"></script>
    <script type="text/javascript" src="http://documentcloud.github.com/underscore/underscore-min.js"></script>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript">
        google.load('visualization', '1', {'packages':['motionchart']});
        google.setOnLoadCallback(drawChart);
        function drawChart() {
            var data = new google.visualization.DataTable();
            data.addColumn('string', 'Fruit');
            data.addColumn('date', 'Date');
            data.addColumn('number', 'Sales');
            data.addColumn('number', 'Expenses');
            data.addColumn('string', 'Location');
            data.addRows([
                ['Apples', new Date(1988, 0, 1), 1000, 300, 'East'],
                ['Oranges', new Date(1988, 0, 1), 1150, 200, 'West'],
                ['Bananas', new Date(1988, 0, 1), 300, 250, 'West'],
                ['Apples', new Date(1989, 6, 1), 1200, 400, 'East'],
                ['Oranges', new Date(1989, 6, 1), 750, 150, 'West'],
                ['Bananas', new Date(1989, 6, 1), 788, 617, 'West']
            ]);
            var chart = new google.visualization.MotionChart(document.getElementById('chart_div'));
            chart.draw(data, {width:600, height:300});
        }
    </script>


    <script type="text/javascript">
        $(document).ready(function () {
            $('input:radio').click(function () {
                var select = $('input:radio[name=viz]:checked').val();
                $('#projects').children('div').each(function (div) {
                    if ($(this).attr('id') == select) {
                        $(this).show();
                    } else {
                        $(this).hide();
                    }
                });
            });
            setInterval(function () {
                getLogs('adp-rick-test');
            }, 1000);
        });

        var lastLog;

        function getLogs(appid) {
            $.get('/log', {'appid':appid}, function (data) {
                var columns = [];
                var newLastLog = 0;
                var docs = _.map(data.rows, function (row) {
                    var doc = row.doc;
                    delete doc._id;
                    delete doc._rev;
                    columns = _.union(columns, _.keys(doc));
                    newLastLog = Math.max(newLastLog, Number(doc.timestamp));
                    return doc;
                });
                if (newLastLog <= lastLog) {
                    return;
                }
                docs = _.sortBy(docs, function (doc) {
                    return -Number(doc.timestamp);
                });
                $('.logs > thead').empty();
                $('.logs > tbody').empty();
                lastLog = newLastLog;

                d3.select('.logs > thead').append('tr').selectAll('tr').data(columns).enter().append('th').html(
                        function (col) {
                            var choices = _.uniq(_.pluck(docs, col));
                            if (choices.length <= 1) {
                                return col; // nothing to choose from, just return the column name
                            }
                            if (choices.length < 5) { // a dropdown box is nice for these choices
                                var dropdown = $('<select></select>');
                                dropdown.append('<option>' + col + '</option>');
                                _.each(choices, function (choice) {
                                    dropdown.append('<option>' + (choice ? choice : '') + '</option>');
                                });
                                return '<select>' + dropdown.html() + '</select>';
                            }
                            return col;
                        }
                );

                d3.select('.logs > tbody').selectAll('tr').data(docs).enter().append('tr').selectAll('td').data(
                        function (doc) {
                            var row = new Array(columns.length);
                            for (var i = 0; i < columns.length; i++) {
                                row[i] = new Object();
                                row[i]['key'] = columns[i];
                                row[i]['value'] = doc[columns[i]];
                            }
                            return row;
                        }).enter().append('td').text(
                        function (cell) {
                            if (cell.key == 'timestamp') {
                                cell.value = d3.time.format.iso(new Date(Number(cell.value)));
                            }
                            return cell.value;
                        }).attr('name', function (cell) {
                            return cell.key;
                        });

                $('.logs select').change(function (src) {
                    var filter = src.target.value;
                    var isAll = src.target.selectedIndex == 0;
                    alert(isAll);
                    // create a filter array of length column - null means all
                    // go through all rows and show or hide them
                });
            });
        }
    </script>

    <style type="text/css">
        body {
            font-family: monospace;
            background-color: black;
            color: #adff2f;
        }

        select {
            background: transparent;
            color: #adff2f;
        }

        table {
            border-collapse: collapse;
            border: 2px solid #006400;
        }

        table td, th {
            border: 1px solid #006400;
        }
    </style>
</head>
<body>

<h2>
    <input type="radio" name="viz" value="logs">logs</input>
    <input type="radio" name="viz" value="stats">stats</input>
    <input type="radio" name="viz" value="terminal">terminal</input>
</h2>

<div id="projects">
    <div id="logs">
        <table class='logs'>
            <thead></thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="stats" style="display: none">
        <div id="chart_div" style="width: 600px; height: 300px;"></div>
    </div>

    <div id="terminal" style="display: none">
        <iframe src="http://192.168.1.137:443" style="width: 90%; height: 300px"></iframe>
    </div>
</div>

</body>
</html>
